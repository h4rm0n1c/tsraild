#!/usr/bin/env sh
set -eu

SOCK="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}/tsrail.sock"

usage() {
  cat <<'USAGE'
Usage: tsrailctl <command> [args]

Commands:
  status
  service-start
  service-stop
  service-restart
  service-status
  key-status
  setkey <apikey>
  approve-uid <uid>
  approve-nick <nickname>
  unapprove-uid <uid>
  approved-list
  ignore-uid <uid>
  unignore-uid <uid>
  ignore-list
  policy <name> <value>
  channels
  dump-state

Shortcuts:
  status        -> status
  setkey        -> setkey <apikey>
  approve-nick  -> approve-nick <nickname>
  approve-uid   -> approve-uid <uid>
  ignore-uid    -> ignore-uid <uid>
  state         -> dump-state (pretty if jq is available)
  users         -> list approved users in the overlay
  unknowns      -> list unknown users in the channel
  service-*     -> manage daemon with ~/tsraild/tsraild.py
USAGE
}

require_socat() {
  if ! command -v socat >/dev/null 2>&1; then
    echo "error: socat is required" >&2
    exit 1
  fi
}

send_cmd() {
  printf '%s\n' "$1" | socat - UNIX-CONNECT:"$SOCK"
}

service_pidfile() {
  printf '%s\n' "${XDG_RUNTIME_DIR:-/run/user/$(id -u)}/tsraild.pid"
}

service_logfile() {
  printf '%s\n' "$HOME/.local/share/tsrail/tsraild.log"
}

service_start() {
  pidfile="$(service_pidfile)"
  logfile="$(service_logfile)"
  if [ -f "$pidfile" ] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
    echo "tsraild already running"
    return 0
  fi
  mkdir -p "$(dirname "$logfile")"
  (cd "$HOME/tsraild" && nohup ./tsraild.py >>"$logfile" 2>&1 & echo $! >"$pidfile")
  echo "started tsraild"
}

service_stop() {
  pidfile="$(service_pidfile)"
  if [ ! -f "$pidfile" ]; then
    echo "tsraild not running"
    return 0
  fi
  pid="$(cat "$pidfile")"
  if kill -0 "$pid" 2>/dev/null; then
    kill "$pid"
  fi
  rm -f "$pidfile"
  echo "stopped tsraild"
}

service_status() {
  pidfile="$(service_pidfile)"
  if [ -f "$pidfile" ] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
    echo "tsraild running"
  else
    echo "tsraild not running"
    return 1
  fi
}

pretty_json() {
  if command -v jq >/dev/null 2>&1; then
    jq .
  else
    cat
  fi
}

list_users() {
  if command -v jq >/dev/null 2>&1; then
    jq -r '.users[]? | "\(.nickname)\tuid=\(.uid)\ttalking=\(.talking)"'
  else
    cat
  fi
}

list_unknowns() {
  if command -v jq >/dev/null 2>&1; then
    jq -r '.unknown_users[]? | "\(.nickname)\tuid=\(.uid)\tclid=\(.clid)"'
  else
    cat
  fi
}

require_socat

if [ $# -lt 1 ]; then
  usage
  exit 1
fi

cmd="$1"
shift

case "$cmd" in
  status|key-status|approved-list|ignore-list|channels|dump-state)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    send_cmd "$cmd"
    ;;
  service-start)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    service_start
    ;;
  service-stop)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    service_stop
    ;;
  service-restart)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    service_stop
    service_start
    ;;
  service-status)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    service_status
    ;;
  state)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    send_cmd "dump-state" | pretty_json
    ;;
  users)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    send_cmd "dump-state" | list_users
    ;;
  unknowns)
    if [ $# -ne 0 ]; then
      usage
      exit 1
    fi
    send_cmd "dump-state" | list_unknowns
    ;;
  setkey)
    if [ $# -ne 1 ]; then
      usage
      exit 1
    fi
    send_cmd "setkey $1"
    ;;
  approve-uid|unapprove-uid|ignore-uid|unignore-uid)
    if [ $# -ne 1 ]; then
      usage
      exit 1
    fi
    send_cmd "$cmd $1"
    ;;
  approve-nick)
    if [ $# -lt 1 ]; then
      usage
      exit 1
    fi
    send_cmd "approve-nick $*"
    ;;
  policy)
    if [ $# -lt 2 ]; then
      usage
      exit 1
    fi
    name="$1"
    shift
    send_cmd "policy $name $*"
    ;;
  *)
    usage
    exit 1
    ;;
 esac
